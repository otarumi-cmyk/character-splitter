# 適職診断ツール 実装手順書

## 📋 目次

1. [準備段階](#準備段階)
2. [WordPressプラグインのインストール](#wordpressプラグインのインストール)
3. [diagnosis.htmlの設定](#diagnosishtmlの設定)
4. [実装内容の確認](#実装内容の確認)
5. [動作確認](#動作確認)
6. [本番環境へのデプロイ](#本番環境へのデプロイ)
7. [トラブルシューティング](#トラブルシューティング)

---

## 準備段階

### ステップ1: 必要なファイルの確認

実装に必要なファイルが揃っているか確認します。

**確認するファイル:**
- ✅ `diagnosis.html` - メインの診断ツール
- ✅ `diagnosis-api-plugin.php` または `wordpress-api.php` - WordPress REST API
- ✅ `diagnosis-api-plugin.zip` - プラグインのzipファイル（プラグイン方式の場合）
- ✅ `実装内容まとめ.md` - 実装の詳細仕様

**確認方法:**
```bash
# ファイルが存在するか確認
ls -la diagnosis.html
ls -la diagnosis-api-plugin.php
ls -la diagnosis-api-plugin.zip
```

### ステップ2: WordPress環境の確認

WordPressサイトが準備できているか確認します。

**確認項目:**
1. WordPressサイトのURLを確認
   - 例: `https://agent.migi-nanameue.co.jp`
2. WordPress管理画面にアクセスできるか確認
   - URL: `https://agent.migi-nanameue.co.jp/wp-admin`
3. プラグインをアップロードする権限があるか確認
   - 管理者権限が必要です

### ステップ3: LIFFアプリの設定確認

LINE Developers ConsoleでLIFFアプリの設定を確認します。

**確認手順:**
1. [LINE Developers Console](https://developers.line.biz/console/) にアクセス
2. プロバイダーを選択
3. チャネルを選択
4. 「LIFF」タブを開く
5. LIFFアプリIDを確認（例: `1657698499-9xjEMXXe`）
6. LIFFアプリのURL許可リストに診断ツールのURLが登録されているか確認

**重要:** LIFFアプリのURL許可リストに診断ツールのURLを追加する必要があります。

---

## WordPressプラグインのインストール

### ステップ4: インストール方法の選択

2つの方法があります。**方法A（プラグイン方式）を推奨**します。

#### 方法A: プラグインとしてインストール（推奨）

**メリット:**
- テーマに依存しない
- 管理が簡単
- 有効化/無効化が簡単

**手順:**
1. WordPress管理画面にログイン
2. 「プラグイン」→「新規追加」をクリック
3. 「プラグインのアップロード」をクリック
4. `diagnosis-api-plugin.zip` を選択してアップロード
5. 「プラグインを有効化」をクリック

#### 方法B: テーマのfunctions.phpに直接追加

**メリット:**
- テーマと一体化できる
- カスタマイズしやすい

**手順:**
1. `wordpress-api.php` をテーマフォルダにアップロード
   - 配置先: `wp-content/themes/your-theme/wordpress-api.php`
   - または子テーマ: `wp-content/themes/your-child-theme/wordpress-api.php`
2. `functions.php` に以下を追加:

```php
// 子テーマの場合
require_once get_stylesheet_directory() . '/wordpress-api.php';

// 親テーマの場合
require_once get_template_directory() . '/wordpress-api.php';
```

### ステップ5: プラグインの有効化確認

**確認手順:**
1. WordPress管理画面 → 「プラグイン」→「インストール済みプラグイン」
2. 「適職診断API」プラグインが表示されているか確認
3. 「有効化」をクリック（まだ有効化されていない場合）
4. エラーメッセージが出ないか確認

### ステップ6: REST APIエンドポイントの動作確認

WordPress REST APIが正しく動作しているか確認します。

**確認手順:**
1. ブラウザで以下のURLにアクセス:
   ```
   https://agent.migi-nanameue.co.jp/wp-json/diagnosis/v1/save-result-by-lineuser
   ```
2. **405エラー（Method Not Allowed）**が表示されれば正常です
   - POSTメソッドのみ許可されているため、GETでアクセスすると405エラーになります
3. **404エラー**が出る場合は設定ミスです
   - プラグインが有効化されているか確認
   - `wordpress-api.php` が正しく配置されているか確認

**同様に以下も確認:**
```
https://agent.migi-nanameue.co.jp/wp-json/diagnosis/v1/get-result-by-lineuser
```
→ 400エラー（Bad Request）が表示されれば正常です（lineUserIdパラメータが必要）

---

## diagnosis.htmlの設定

### ステップ7: LIFF SDKの読み込み確認

`diagnosis.html` の `<head>` 内にLIFF SDKが読み込まれているか確認します。

**確認箇所:** `<head>` タグ内（10行目付近）

**確認内容:**
```html
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
```

**もしなければ追加:**
```html
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16タイプ仕事診断</title>
    <!-- LIFF SDKの読み込み -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        /* ... */
    </style>
</head>
```

### ステップ8: LIFF IDの設定

実際のLIFFアプリIDに変更します。

**確認箇所:** `diagnosis.html` の1208行目付近

**現在の設定:**
```javascript
const LIFF_ID = '1657698499-9xjEMXXe'; // 実際のLIFFアプリIDに置き換えてください
```

**変更方法:**
1. LINE Developers ConsoleでLIFFアプリIDを確認
2. `'1657698499-9xjEMXXe'` を実際のLIFFアプリIDに置き換える

**例:**
```javascript
const LIFF_ID = '1234567890-abcdefgh'; // 実際のLIFFアプリID
```

**重要:** 開発環境と本番環境で異なるLIFFアプリIDを使用する場合は、環境に応じて変更してください。

### ステップ9: WordPress APIのベースURL設定

本番環境の場合は、実際のWordPressサイトのURLに変更します。

**確認箇所:** `diagnosis.html` の1190行目付近

**現在の設定:**
```javascript
const WP_API_BASE = window.location.origin + '/wp-json/diagnosis/v1';
```

**本番環境の場合:**
```javascript
// 本番環境のWordPressサイトのURLを指定
const WP_API_BASE = 'https://agent.migi-nanameue.co.jp/wp-json/diagnosis/v1';
```

**開発環境の場合:**
```javascript
// 開発環境のWordPressサイトのURLを指定
const WP_API_BASE = 'http://localhost:8080/wp-json/diagnosis/v1';
```

**環境に応じた設定例:**
```javascript
// 環境判定（例）
const isProduction = window.location.hostname !== 'localhost';
const WP_API_BASE = isProduction 
    ? 'https://agent.migi-nanameue.co.jp/wp-json/diagnosis/v1'
    : window.location.origin + '/wp-json/diagnosis/v1';
```

---

## 実装内容の確認

### ステップ10: 追加質問機能の実装確認

4つの追加質問が正しく実装されているか確認します。

**確認箇所:** `diagnosis.html` の739行目付近（`additionalQuestions` オブジェクト）

#### 質問1: 年齢（1問目）

**確認内容:**
- 質問文: 「あなたの年齢を教えてください」
- 選択肢: 6個の年齢レンジ
  - 18-19歳
  - 20-24歳
  - 25-29歳
  - 30-34歳
  - 35-39歳
  - 40歳以上

**コード確認:**
```javascript
age: {
    questionType: "age",
    text: "あなたの年齢を教えてください",
    options: [
        { value: 19, label: "18-19歳", minAge: 18, maxAge: 19 },
        { value: 22, label: "20-24歳", minAge: 20, maxAge: 24 },
        { value: 27, label: "25-29歳", minAge: 25, maxAge: 29 },
        { value: 32, label: "30-34歳", minAge: 30, maxAge: 34 },
        { value: 37, label: "35-39歳", minAge: 35, maxAge: 39 },
        { value: 40, label: "40歳以上", minAge: 40, maxAge: 100 }
    ]
}
```

#### 質問2: 住まい（2問目）

**確認内容:**
- 質問文: 「現在お住まいの都道府県を教えてください」
- 選択肢: 8個の都道府県
  - 東京都
  - 神奈川県
  - 埼玉県
  - 千葉県
  - 大阪府
  - 福岡県
  - 愛知県
  - その他

**コード確認:**
```javascript
location: {
    questionType: "location",
    text: "現在お住まいの都道府県を教えてください",
    options: [
        { value: "東京都", label: "東京都" },
        { value: "神奈川県", label: "神奈川県" },
        { value: "埼玉県", label: "埼玉県" },
        { value: "千葉県", label: "千葉県" },
        { value: "大阪府", label: "大阪府" },
        { value: "福岡県", label: "福岡県" },
        { value: "愛知県", label: "愛知県" },
        { value: "その他", label: "その他" }
    ]
}
```

#### 質問3: 転職時期（3問目）

**確認内容:**
- 質問文: 「転職を検討している場合、どのタイミングを考えていますか？」
- 選択肢: 6個
  - すぐに（1ヶ月以内）
  - 3ヶ月以内
  - 6ヶ月以内
  - 1年以内
  - 1年以上先
  - 転職は考えていない

#### 質問4: 転職回数（4問目）

**確認内容:**
- 質問文: 「転職回数は何回ですか？（現在の会社を含めて何社目か）」
- 選択肢: 4個
  - 転職経験なし（1社目）
  - 1回（2社目）
  - 2回（3社目）
  - 3回以上（4社目以上）

### ステップ11: 質問配列の確認

質問が正しい順序で配列に追加されているか確認します。

**確認箇所:** `diagnosis.html` の821行目付近

**確認内容:**
```javascript
// 質問配列を構築（最初の4問を追加質問にする）
const questions = [
    { id: "age", questionType: "age", isAdditional: true },             // 1問目: 年齢
    { id: "location", questionType: "location", isAdditional: true },   // 2問目: 住まい
    { id: "jobChangeTiming", questionType: "jobChangeTiming", isAdditional: true }, // 3問目: 転職時期
    { id: "jobChangeCount", questionType: "jobChangeCount", isAdditional: true }, // 4問目: 転職回数
    ...personalityQuestions                                           // 5問目以降: 性格診断20問
];
```

**質問カウンターの確認:**
- 初期表示が「Q 1 / 24」になっているか確認（611行目付近）

### ステップ12: 配布タグ判定ロジックの確認

4つの条件がすべて満たされた場合に配布タグを付与するロジックを確認します。

**確認箇所:** `diagnosis.html` の2210行目付近（`finishQuiz` 関数内）

**確認内容:**
```javascript
// 配布タグの判定
const shouldAddDistributionTag = 
    additionalAnswers.age && additionalAnswers.age.isTargetAge === true &&      // 20-29歳
    additionalAnswers.location && additionalAnswers.location.isTargetRegion === true && // 東京、神奈川、埼玉、千葉、大阪、福岡、愛知
    additionalAnswers.jobChangeTiming && additionalAnswers.jobChangeTiming.isTargetTiming === true && // 1年以内
    additionalAnswers.jobChangeCount && additionalAnswers.jobChangeCount.isTargetJobChangeCount === true; // 転職回数2回まで（経験社数3社まで）
```

**各条件の判定内容:**

1. **年齢（isTargetAge）**: 20-29歳レンジの場合true
   - 確認箇所: 1651行目付近
   ```javascript
   const isTargetAge = (minAge >= 20 && maxAge <= 29);
   ```

2. **住まい（isTargetRegion）**: 東京、神奈川、埼玉、千葉、大阪、福岡、愛知の場合true
   - 確認箇所: 1665行目付近
   ```javascript
   const isTargetRegion = prefecture === "東京都" || 
                         prefecture === "神奈川県" || 
                         prefecture === "埼玉県" || 
                         prefecture === "千葉県" || 
                         prefecture === "大阪府" || 
                         prefecture === "福岡県" || 
                         prefecture === "愛知県";
   ```

3. **転職時期（isTargetTiming）**: 1年以内の場合true
   - 確認箇所: 1680行目付近
   ```javascript
   const isTargetTiming = jobChangeTiming === "1month" || 
                         jobChangeTiming === "3months" || 
                         jobChangeTiming === "6months" || 
                         jobChangeTiming === "1year";
   ```

4. **転職回数（isTargetJobChangeCount）**: 転職回数2回まで（経験社数3社まで）の場合true
   - 確認箇所: 1675行目付近
   ```javascript
   const isTargetJobChangeCount = jobChangeCount <= 2;
   ```

### ステップ13: LIFF連携機能の確認

LIFF関連の関数が正しく実装されているか確認します。

**確認する関数:**

1. **initLIFF()** - LIFF初期化
   - 確認箇所: 1215行目付近
   ```javascript
   async function initLIFF() {
       if (typeof liff === 'undefined') {
           console.log('initLIFF: LIFF SDK is not loaded');
           return false;
       }
       try {
           await liff.init({ liffId: LIFF_ID });
           liffInitialized = true;
           liffLoggedIn = liff.isLoggedIn();
           return true;
       } catch (error) {
           console.warn('initLIFF: 初期化エラー', error);
           return false;
       }
   }
   ```

2. **getLineUserId()** - lineUserId取得
   - 確認箇所: 1234行目付近
   ```javascript
   async function getLineUserId() {
       if (!liffInitialized) {
           const initialized = await initLIFF();
           if (!initialized) return null;
       }
       if (!liffLoggedIn) return null;
       try {
           const profile = await liff.getProfile();
           return profile.userId;
       } catch (error) {
           console.warn('getLineUserId: プロファイル取得エラー', error);
           return null;
       }
   }
   ```

3. **saveResultByLineUser()** - lineUserIdで結果を保存
   - 確認箇所: 1334行目付近

4. **getResultByLineUser()** - lineUserIdで結果を取得
   - 確認箇所: 1370行目付近

### ステップ14: Cookie使用の完全削除確認

Cookieが一切使用されていないか確認します。

**確認項目:**

1. **getSessionId()関数** - sessionStorageのみ使用
   - 確認箇所: 1160行目付近
   - `document.cookie` を使っていないことを確認

2. **setCookie()関数** - 削除されているか確認
   - `diagnosis.html` 全体で `setCookie` を検索
   - 見つからなければOK

3. **WordPress API側** - Cookie処理が削除されているか確認
   - `wordpress-api.php` または `diagnosis-api-plugin.php` で `$_COOKIE` を検索
   - 見つからなければOK

### ステップ15: 配布タグ表示機能の確認

結果画面に配布タグ情報が正しく表示されるか確認します。

**確認箇所:**

1. **HTML構造** - 716行目付近
   ```html
   <div id="distribution-tag-details">
       <div>年齢: <span id="tag-age">-</span></div>
       <div>地域: <span id="tag-location">-</span></div>
       <div>転職タイミング: <span id="tag-timing">-</span></div>
       <div>転職回数: <span id="tag-jobChangeCount">-</span></div>
   </div>
   ```

2. **updateDistributionTagDisplay()関数** - 1882行目付近
   - 転職回数の表示が追加されているか確認
   - 各条件の表示が正しく更新されるか確認

---

## 動作確認

### ステップ16: 基本動作確認（ブラウザ）

ブラウザで基本的な動作を確認します。

**確認手順:**

1. `diagnosis.html` をブラウザで開く
2. 開発者ツール（F12）のConsoleタブを開く
3. 診断を完了
4. コンソールログを確認:
   - ✅ `initLIFF: 初期化完了` が表示される
   - ✅ LIFFログイン時: `getLineUserId: lineUserId取得` が表示される
   - ✅ LIFFログイン時: `saveResultByLineUser: サーバーに保存完了` が表示される
   - ✅ LIFF未ログイン時: `saveResultToCache: サーバーに保存完了` が表示される

**確認用コマンド（コンソールで実行）:**

```javascript
// LIFF SDKが読み込まれているか確認
typeof liff  // "object" が返ればOK

// LIFF初期化状態を確認
liffInitialized  // true が返ればOK
liffLoggedIn     // LIFFログイン時は true

// lineUserIdを取得
await getLineUserId()  // lineUserIdが返ればOK

// 保存された診断結果を確認
JSON.parse(localStorage.getItem('latest_diagnosis_result'))
```

### ステップ17: LIFF経由での動作確認

LINEアプリ内でLIFF URLを開いて動作を確認します。

**確認手順:**

1. LINEアプリ内でLIFF URLを開く
   - URL: `https://liff.line.me/1657698499-9xjEMXXe/diagnosis`（実際のLIFF IDに置き換え）
2. 診断を完了
3. 結果が正しく表示されるか確認
4. 後日、同じLINEアカウントで結果を再表示できるか確認

**確認ポイント:**
- ✅ LIFFアプリが正しく起動する
- ✅ 診断が完了できる
- ✅ 結果が正しく表示される
- ✅ 24時間以内であれば、後日も結果を再表示できる

### ステップ18: 動線1の確認（スマホ → スマホ → スマホ）

**確認手順:**

1. **スマホブラウザで診断を完了**
   - スマホのブラウザで `diagnosis.html` を開く
   - 診断を完了
   - LINE登録画面が表示される
2. **スマホでLINE登録**
   - QRコードを読み取るか、LINE URLを開く
   - LINE公式アカウントを友だち追加
3. **スマホのLINEアプリ内で結果を確認**
   - LINEアプリ内で「診断結果を見る」ボタンをタップ
   - 結果が正しく表示されるか確認

**確認ポイント:**
- ✅ スマホで診断が完了できる
- ✅ LINE登録画面が表示される
- ✅ LINEアプリ内で結果を確認できる

### ステップ19: 動線2の確認（PC → PC → PC）

**確認手順:**

1. **PCブラウザで診断を完了**
   - PCのブラウザで `diagnosis.html` を開く
   - 診断を完了
   - LINE登録画面が表示される
2. **PCでLINE登録**
   - PCのLINEアプリでLINE URLを開く
   - LINE公式アカウントを友だち追加
3. **PCのLINEアプリ内で結果を確認**
   - PCのLINEアプリ内で「診断結果を見る」ボタンをクリック
   - 結果が正しく表示されるか確認

**確認ポイント:**
- ✅ PCで診断が完了できる
- ✅ LINE登録画面が表示される
- ✅ PCのLINEアプリ内で結果を確認できる

### ステップ20: 動線3の確認（PC → スマホ → スマホ）

**確認手順:**

1. **PCブラウザで診断を完了**
   - PCのブラウザで `diagnosis.html` を開く
   - 診断を完了
   - LINE登録画面が表示される（QRコードが表示される）
2. **スマホでQRコードを読み取り**
   - スマホのカメラでQRコードを読み取る
   - LINEアプリが起動する
   - LINE公式アカウントを友だち追加
3. **スマホのLINEアプリ内で結果を確認**
   - スマホのLINEアプリ内で「診断結果を見る」ボタンをタップ
   - **PCで診断した結果が表示される**ことを確認

**確認ポイント:**
- ✅ PCで診断が完了できる
- ✅ QRコードが正しく表示される
- ✅ スマホでQRコードを読み取れる
- ✅ **PCで診断した結果がスマホで表示される**（重要！）

### ステップ21: 配布タグ判定の確認

配布タグが正しく判定されるか確認します。

**テストケース1: 条件を満たすケース**

1. 以下の条件で診断を完了:
   - 年齢: 20-24歳または25-29歳を選択
   - 住まい: 東京、神奈川、埼玉、千葉、大阪、福岡、愛知のいずれかを選択
   - 転職時期: すぐに、3ヶ月以内、6ヶ月以内、1年以内のいずれかを選択
   - 転職回数: 転職経験なし、1回、2回のいずれかを選択
2. コンソールで以下を確認:
   ```javascript
   const cacheData = JSON.parse(localStorage.getItem('latest_diagnosis_result'));
   console.log('配布タグ:', cacheData.distributionTag);  // true が返ればOK
   console.log('配布タグ詳細:', cacheData.distributionTagDetails);
   ```
3. 結果画面で配布タグ情報を確認:
   - 「✓ 対象」と表示される
   - 各条件が「✓ 対象」と表示される

**テストケース2: 条件を満たさないケース**

1. 以下のいずれかの条件で診断を完了:
   - 年齢: 30-34歳以上を選択
   - 住まい: 「その他」を選択
   - 転職時期: 「1年以上先」または「転職は考えていない」を選択
   - 転職回数: 「3回以上」を選択
2. コンソールで以下を確認:
   ```javascript
   const cacheData = JSON.parse(localStorage.getItem('latest_diagnosis_result'));
   console.log('配布タグ:', cacheData.distributionTag);  // false が返ればOK
   ```
3. 結果画面で配布タグ情報を確認:
   - 「✗ 対象外」と表示される
   - 満たしていない条件が「✗ 対象外」と表示される

### ステップ22: エラーチェック

エラーが発生していないか確認します。

**確認項目:**

1. **ブラウザのコンソール**
   - エラーメッセージが出ていないか確認
   - 警告メッセージがあれば内容を確認

2. **WordPress REST API**
   - ネットワークタブでAPIリクエストが成功しているか確認
   - ステータスコードが200または201であることを確認

3. **サーバーのエラーログ**
   - WordPressのデバッグログを確認
   - サーバーのエラーログを確認

**確認用コマンド:**

```javascript
// コンソールで実行
// エラーがないか確認
console.error  // エラーログがないか確認

// ネットワークリクエストを確認
// 開発者ツールのNetworkタブで以下を確認:
// - POST /wp-json/diagnosis/v1/save-result-by-lineuser (200または201)
// - GET /wp-json/diagnosis/v1/get-result-by-lineuser (200)
```

---

## 本番環境へのデプロイ

### ステップ23: 本番環境へのファイルアップロード

本番サーバーにファイルをアップロードします。

**アップロードするファイル:**

1. **diagnosis.html**
   - 本番サーバーの適切な場所にアップロード
   - 例: `https://agent.migi-nanameue.co.jp/diagnosis.html`

2. **WordPress APIファイル（プラグイン）**
   - プラグイン方式の場合: `diagnosis-api-plugin.zip` をアップロード
   - テーマ方式の場合: `wordpress-api.php` をテーマフォルダにアップロード

**アップロード方法:**

- **FTP/SFTPを使用:**
  ```bash
  # diagnosis.htmlをアップロード
  scp diagnosis.html user@agent.migi-nanameue.co.jp:/path/to/html/
  
  # プラグインをアップロード（プラグイン方式の場合）
  scp diagnosis-api-plugin.zip user@agent.migi-nanameue.co.jp:/path/to/wp-content/plugins/
  ```

- **WordPress管理画面を使用（プラグイン方式の場合）:**
  1. WordPress管理画面 → プラグイン → 新規追加
  2. 「プラグインのアップロード」をクリック
  3. `diagnosis-api-plugin.zip` をアップロード

**ファイルのパーミッション確認:**
```bash
# ファイルの読み取り権限を確認
chmod 644 diagnosis.html
chmod 644 wordpress-api.php
```

### ステップ24: 本番環境の設定確認

本番環境で正しく設定されているか確認します。

**確認項目:**

1. **LIFF ID**
   - `diagnosis.html` のLIFF IDが本番環境用か確認
   - 開発環境と本番環境で異なる場合は注意

2. **WP_API_BASE**
   - 本番環境のWordPressサイトのURLになっているか確認
   ```javascript
   const WP_API_BASE = 'https://agent.migi-nanameue.co.jp/wp-json/diagnosis/v1';
   ```

3. **WordPressプラグイン**
   - プラグインが有効化されているか確認
   - REST APIエンドポイントが動作しているか確認

**確認手順:**

1. 本番環境の `diagnosis.html` をブラウザで開く
2. 開発者ツール（F12）のConsoleタブを開く
3. 以下を実行:
   ```javascript
   // LIFF IDを確認
   LIFF_ID  // 本番環境用のLIFF IDが表示される
   
   // WordPress APIのベースURLを確認
   WP_API_BASE  // 本番環境のURLが表示される
   ```

### ステップ25: Lステップ側の設定

Lステップ管理画面で固定URLを設定します。

**設定手順:**

1. **Lステップ管理画面にアクセス**
2. **固定URL1個を設定**
   - URL: `https://agent.migi-nanameue.co.jp/diagnosis.html`
   - またはLIFF URL: `https://liff.line.me/1657698499-9xjEMXXe/diagnosis`
3. **「診断結果を見る」ボタンに固定URLを設定**
   - メッセージテンプレートで「診断結果を見る」ボタンを作成
   - ボタンのURLに固定URLを設定
4. **リッチメニューに「診断結果を見る」を追加（オプション）**
   - リッチメニューに「診断結果を見る」項目を追加
   - URLに固定URLを設定

**重要:**
- URLパラメータは不要（診断ツール側でlineUserIdを自動取得）
- ユーザーごとに異なるURLを設定する必要はない

**メッセージ例:**

```
【適職診断の結果を見る】

あなたの診断結果が準備できました！
下のボタンから結果を確認してください。

[診断結果を見る] ← このボタンに固定URLを設定
```

### ステップ26: 最終動作確認

本番環境で最終的な動作確認を行います。

**確認項目:**

1. **3つの動線すべてをテスト**
   - 動線1: スマホ → スマホ → スマホ
   - 動線2: PC → PC → PC
   - 動線3: PC → スマホ → スマホ

2. **配布タグが正しく判定されるか確認**
   - 条件を満たすケースで `distributionTag: true` になるか確認
   - 条件を満たさないケースで `distributionTag: false` になるか確認

3. **エラーが発生しないか確認**
   - ブラウザのコンソールにエラーが出ていないか確認
   - WordPress REST APIが正しく動作しているか確認

4. **24時間後のデータ有効期限も確認**
   - 診断完了から24時間以内: 結果が表示される
   - 診断完了から24時間経過後: デフォルト結果が表示される（または診断開始画面）

**確認手順:**

1. 本番環境で診断を完了
2. 結果が正しく表示されるか確認
3. 配布タグが正しく判定されるか確認
4. エラーが発生していないか確認
5. 24時間後に再度アクセスして、データ有効期限を確認

---

## トラブルシューティング

### LIFFが初期化されない場合

**確認事項:**
- LIFF SDKが正しく読み込まれているか（`<head>`内にスクリプトタグがあるか）
- LIFF IDが正しいか
- LIFFアプリの設定（URL許可リストなど）を確認

**対処法:**
1. ブラウザのコンソールで `typeof liff` を実行
   - `"object"` が返ればSDKは読み込まれている
   - `"undefined"` が返ればSDKが読み込まれていない
2. LIFFアプリの管理画面で、診断ツールのURLが許可リストに含まれているか確認
3. LIFF IDが正しいか確認

### 診断結果が保存されない場合

**確認事項:**
- WordPress REST APIが正しく動作しているか
- `WP_API_BASE` のURLが正しいか
- サーバーのエラーログを確認

**対処法:**
1. ブラウザのコンソールで `WP_API_BASE` を実行してURLを確認
2. WordPressのデバッグモードを有効にしてエラーログを確認
3. `wordpress-api.php` が正しく配置されているか確認
4. ネットワークタブでAPIリクエストが成功しているか確認

### 結果が取得できない場合

**確認事項:**
- lineUserIdが正しく取得できているか
- WordPress Transientにデータが保存されているか
- 24時間以内のデータか（Transientは24時間で期限切れ）

**対処法:**
1. コンソールで `await getLineUserId()` を実行してlineUserIdが取得できるか確認
2. WordPressのデータベースでTransientを確認
   - `wp_options` テーブルの `_transient_diagnosis_result_lineuser_*` を検索
3. 診断完了から24時間以内か確認

### Cookieエラーが出る場合

**確認事項:**
- `getSessionId()` 関数からCookie使用が削除されているか
- `setCookie()` 関数が削除されているか

**対処法:**
1. `diagnosis.html` で `setCookie` を検索して、残っていないか確認
2. `getSessionId()` 関数内で `document.cookie` を使っていないか確認
3. WordPress API側でもCookie処理が削除されているか確認

---

## 完了基準

すべてのステップが完了し、以下が確認できれば実装完了です:

1. ✅ WordPressプラグインが正しく配置され、動作している
2. ✅ LIFF IDが正しく設定されている
3. ✅ 4つの追加質問が正しく実装されている
4. ✅ 配布タグが正しく判定される
5. ✅ 3つの動線すべてが動作する
6. ✅ エラーが発生しない
7. ✅ 本番環境にデプロイ済み
8. ✅ Lステップ側の設定が完了している

---

## 参考資料

- `実装内容まとめ.md`: 実装の詳細仕様
- `実装完了後の次のステップ.md`: 動作確認のチェックリスト
- `プラグインインストール手順.md`: プラグインのインストール方法

---

## サポート

問題が発生した場合:

1. ブラウザのコンソールログを確認
2. WordPressのエラーログを確認
3. 上記のトラブルシューティングを参照
4. 必要に応じて、エラーメッセージとログを共有してください

