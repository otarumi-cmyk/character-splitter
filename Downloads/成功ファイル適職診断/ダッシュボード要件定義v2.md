# 診断結果集計ダッシュボード 要件定義書 v2

## 1. 概要

WordPress管理画面内に、適職診断ツールの集計データを表示するダッシュボードを構築する。

## 2. 必要なデータ

### 2.1 ユーザー情報
| 項目 | 説明 | 取得元 |
|------|------|--------|
| LINE User ID | LINEユーザーの一意識別子 | LIFF SDK |
| LINE表示名 | LINEでの表示名 | LIFF SDK (`liff.getProfile()`) |
| セッションID | 診断セッションの識別子 | クライアント側で生成 |
| 登録日時 | 診断結果が保存された日時 | サーバー側でタイムスタンプ |

### 2.2 追加質問の回答（最初の4問）
| 項目 | 質問内容 | 選択肢 |
|------|----------|--------|
| 年齢 | あなたの年齢を教えてください | 18-19歳, 20-24歳, 25-29歳, 30-34歳, 35-39歳, 40歳以上 |
| 住まい | 現在お住まいの都道府県を教えてください | 東京都, 神奈川県, 埼玉県, 千葉県, 大阪府, 福岡県, 愛知県, その他 |
| 転職時期 | 転職を検討している場合、どのタイミングを考えていますか？ | すぐに（1ヶ月以内）, 3ヶ月以内, 6ヶ月以内, 1年以内, 1年以上先, 転職は考えていない |
| 転職回数 | 転職回数は何回ですか？ | 転職経験なし（1社目）, 1回（2社目）, 2回（3社目）, 3回以上（4社目以上） |

### 2.3 診断結果
| 項目 | 説明 |
|------|------|
| タイプID | 16タイプの識別子（例: ESTJ, INFP） |
| タイプ名 | タイプの日本語名（例: サポート実務人材） |
| 配布タグ | 配布対象かどうか（true/false） |
| 配布タグ詳細 | 各条件の判定結果（age, location, timing, jobChangeCount） |

## 3. 集計指標

### 3.1 基本統計
- **総診断数**: 診断を完了した人数
- **配布タグ対象者数**: 配布タグがtrueの人数
- **配布タグ対象率**: 配布タグ対象者数 / 総診断数 × 100%

### 3.2 質問別回答分布
各追加質問について、選択肢ごとの回答数と割合を表示

例：
```
年齢分布:
- 18-19歳: 5人 (5%)
- 20-24歳: 30人 (30%)
- 25-29歳: 40人 (40%)
- 30-34歳: 15人 (15%)
- 35-39歳: 7人 (7%)
- 40歳以上: 3人 (3%)
```

### 3.3 タイプ別分布
16タイプごとの診断結果数と割合

### 3.4 完了率（オプション）
- 診断開始数（Q1表示数）に対する完了数の割合
- ※ 診断開始のトラッキングには追加実装が必要

## 4. ダッシュボード画面構成

### 4.1 サマリーセクション
```
┌─────────────────────────────────────────────────────┐
│  📊 診断結果サマリー                                │
├─────────────────────────────────────────────────────┤
│  総診断数: 1,234 人                                 │
│  配布タグ対象: 456 人 (37.0%)                       │
│  本日の診断数: 12 人                                │
└─────────────────────────────────────────────────────┘
```

### 4.2 質問別回答分布セクション
```
┌─────────────────────────────────────────────────────┐
│  📝 追加質問の回答分布                              │
├─────────────────────────────────────────────────────┤
│  【年齢】                                           │
│  ▓▓▓▓▓▓▓▓░░ 20-24歳 30%                           │
│  ▓▓▓▓▓▓▓▓▓▓ 25-29歳 40%                           │
│  ▓▓▓▓░░░░░░ 30-34歳 15%                           │
│  ...                                                │
├─────────────────────────────────────────────────────┤
│  【住まい】                                          │
│  ▓▓▓▓▓▓▓▓░░ 東京都 35%                            │
│  ...                                                │
└─────────────────────────────────────────────────────┘
```

### 4.3 ユーザー一覧セクション
```
┌──────────────────────────────────────────────────────────────────────────────┐
│  👥 診断結果一覧                           [CSVダウンロード] [絞り込み ▼]   │
├──────────────────────────────────────────────────────────────────────────────┤
│  LINE名 | タイプ | 年齢 | 住まい | 転職時期 | 転職回数 | 配布 | 登録日時    │
├──────────────────────────────────────────────────────────────────────────────┤
│  田中太郎 | ESTJ | 25-29歳 | 東京都 | 3ヶ月以内 | 1回 | ✓ | 2024/12/24 15:30 │
│  山田花子 | INFP | 20-24歳 | 大阪府 | 1年以内 | 0回 | ✓ | 2024/12/24 14:20 │
│  ...                                                                         │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 5. 実装方針

### 5.1 データ保存の変更
現在の `diagnosis-api-plugin.php` を拡張し、以下の情報を追加で保存：

```php
$cache_data = array(
    // 既存フィールド
    'typeId' => ...,
    'typeName' => ...,
    'scores' => ...,
    'answers' => ...,
    'additionalAnswers' => ...,  // ← ここに4問の回答
    'distributionTag' => ...,
    'distributionTagDetails' => ...,
    'timestamp' => ...,
    
    // 新規追加
    'lineDisplayName' => $line_display_name,  // LINE表示名
    'sessionId' => $session_id,               // セッションID
);
```

### 5.2 LINE表示名の取得
クライアント側（diagnosis.html）で `liff.getProfile()` を呼び出し、`displayName` を取得してサーバーに送信。

```javascript
const profile = await liff.getProfile();
const displayName = profile.displayName;
```

### 5.3 新規APIエンドポイント

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| `/diagnosis/v1/stats` | GET | 集計統計を取得 |
| `/diagnosis/v1/list-all` | GET | 全ユーザーの診断結果一覧 |
| `/diagnosis/v1/export-csv` | GET | CSV形式でエクスポート |

### 5.4 管理画面メニュー
WordPress管理画面の「診断結果」メニューを拡張：
- **ダッシュボード**: サマリーと分布グラフ
- **ユーザー一覧**: 詳細データの一覧表示
- **CSVエクスポート**: データダウンロード

## 6. セキュリティ考慮事項

- ダッシュボードは管理者（`manage_options`権限）のみアクセス可能
- LINE User IDは個人情報として適切に管理
- CSVエクスポートはログを残す（監査用）

## 7. 優先順位

### Phase 1（最優先）
1. LINE表示名の保存機能追加
2. 全ユーザー一覧表示
3. CSVエクスポート

### Phase 2
4. サマリー統計表示
5. 質問別回答分布グラフ

### Phase 3（オプション）
6. 完了率トラッキング
7. 日別・週別・月別の推移グラフ

## 8. 次のステップ

1. この要件定義を確認・承認
2. Phase 1の実装開始
3. テスト・デプロイ
