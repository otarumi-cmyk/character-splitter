# 想定年収診断 実装手順書

## 概要
ユーザーが年収とスキルを入力し、転職時の想定年収を診断するツール。
LINE連携により、診断結果をLINE経由で表示し、ダッシュボードでユーザーデータを管理できる。

---

## ファイル構成

| ファイル | 説明 |
|---------|------|
| `salary-estimation-unified.html` | 診断・LINE登録・結果表示を統合したHTMLファイル |
| `salary-estimation-api-plugin.php` | WordPress用プラグイン（API + ダッシュボード） |
| `salary-estimation-api-plugin.zip` | プラグインのzipファイル（WordPress用） |

---

## セットアップ手順

### 1. WordPressプラグインのインストール

1. WordPress管理画面にログイン
2. **プラグイン** → **新規追加** → **プラグインのアップロード**
3. `salary-estimation-api-plugin.zip` を選択してインストール
4. **有効化**をクリック

### 2. LINE Developers設定

#### LIFFアプリの作成
1. [LINE Developers Console](https://developers.line.biz/) にログイン
2. プロバイダーを選択（または新規作成）
3. **LINE Login**チャネルを作成
4. **LIFF**タブ → **追加**
5. 設定内容：
   - サイズ: `Full`
   - エンドポイントURL: HTMLファイルのURL（例: `https://example.com/salary-estimation.html`）
   - Scope: `profile` を有効化
6. LIFF IDをメモ

#### URL許可リスト
1. LIFFアプリの設定画面
2. **リンク先URL許可リスト** にHTMLファイルのURLを追加

### 3. HTMLファイルの設定変更

`salary-estimation-unified.html` の以下の部分を環境に合わせて変更：

```javascript
// WordPress API URL（年収診断用）
const WP_API_BASE = window.location.origin + '/column/wp-json/salary-estimation/v1';

// LIFF設定
const LIFF_ID = '2008810576-LCmxRyHY';  // ← 取得したLIFF IDに変更

// LINE登録URL
const LINE_REGISTRATION_BASE_URL = 'https://liff.line.me/xxxxx/landing?...';  // ← LステップのURLに変更
```

### 4. HTMLファイルのアップロード

WordPressのメディアライブラリまたはサーバーに直接アップロード

---

## REST APIエンドポイント

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/wp-json/salary-estimation/v1/save-result` | POST | セッションIDで結果保存 |
| `/wp-json/salary-estimation/v1/get-result` | GET | セッションIDで結果取得 |
| `/wp-json/salary-estimation/v1/save-result-by-lineuser` | POST | LINE User IDで結果保存 |
| `/wp-json/salary-estimation/v1/get-result-by-lineuser` | GET | LINE User IDで結果取得 |
| `/wp-json/salary-estimation/v1/claim-pending-result` | POST | PENDING結果をLINE User IDにリンク |
| `/wp-json/salary-estimation/v1/debug` | GET | デバッグ情報取得 |

---

## ダッシュボード機能

WordPress管理画面 → **年収診断**メニュー

### サマリー
- 総診断数
- 配布タグ対象数
- 本日の診断数
- 年齢・住まい・転職時期・転職回数の分布

### ユーザー一覧
| 表示項目 |
|---------|
| LINE User ID |
| LINE名 |
| 年齢 |
| 住まい |
| 転職時期 |
| 転職回数 |
| 配布タグ |
| 登録日時 |

### CSVダウンロード
- 全データまたは配布タグのみをCSV出力可能

---

## 配布タグ判定条件

以下の**すべて**を満たす場合に配布タグ = true

| 条件 | 対象 |
|------|------|
| 年齢 | 20〜34歳 |
| 住まい | 東京都、神奈川県、埼玉県、千葉県、大阪府、福岡県、愛知県 |
| 転職時期 | すぐに〜1年以内 |
| 転職回数 | 2回以下 |

---

## トラブルシューティング

### APIが404エラーになる
- プラグインが有効化されているか確認
- パーマリンク設定を再保存（設定 → パーマリンク → 変更を保存）
- WordPressのサブディレクトリ構成の場合、`WP_API_BASE`のパスを確認

### 結果が表示されない
- LIFF IDが正しいか確認
- LIFFエンドポイントURLが正しいか確認
- デバッグAPI（`/wp-json/salary-estimation/v1/debug`）で状態確認

### ダッシュボードにデータが表示されない
- `displayResult`で`saveResultByLineUser`が呼ばれているか確認
- LINE User IDが正しく取得できているか確認

---

## 更新履歴

- 2026-01-04: 初版作成
  - LINE連携機能実装
  - 配布タグ機能実装
  - ダッシュボード機能実装

